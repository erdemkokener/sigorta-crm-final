<form action="/customers/<%= customer.id %>/invoice" method="post">
  <div class="row mb-4 d-print-none">
    <div class="col-md-8">
      <h1 class="h3"><i class="bi bi-receipt"></i> Fatura / Tahsilat Formu</h1>
      <div class="text-muted">
        Müşteri: <strong><%= customer.name %></strong> | Toplam Borç (sisteme göre): 
        <strong><%= stats.totalRemaining.toFixed ? stats.totalRemaining.toFixed(2) : stats.totalRemaining %></strong>
      </div>
      <% if (msg) { %>
        <div class="alert alert-success mt-2"><%= msg %></div>
      <% } %>
      <% if (error) { %>
        <div class="alert alert-danger mt-2"><%= error %></div>
      <% } %>
    </div>
    <div class="col-md-4 text-end">
      <a href="/customers/<%= customer.id %>" class="btn btn-secondary d-print-none"><i class="bi bi-arrow-left"></i> Müşteri Ekranına Dön</a>
      <button type="button" class="btn btn-success d-print-inline" onclick="window.print()"><i class="bi bi-printer"></i> Yazdır</button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <h5>Firma / Acente Bilgileri</h5>
        <p class="mb-1"><strong>Unvan:</strong> Sigorta CRM</p>
        <p class="mb-1"><strong>Tarih:</strong> <span id="invoiceDate"></span></p>
        <input type="hidden" name="date" id="invoiceDateInput">
      </div>
      <div class="col-md-6">
        <h5>Müşteri Bilgileri</h5>
        <p class="mb-1"><strong>Ad Soyad:</strong> <%= customer.name %></p>
        <p class="mb-1"><strong>Telefon:</strong> <%= customer.phone || '-' %></p>
        <p class="mb-1"><strong>TC/Vergi No:</strong> <%= customer.id_no || '-' %></p>
      </div>
    </div>

    <div class="table-responsive mb-3">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Poliçe No</th>
            <th>Şirket</th>
            <th>Tür</th>
            <th>Başlangıç</th>
            <th>Bitiş</th>
            <th class="text-end">Toplam Prim</th>
            <th class="text-end">Ödenen</th>
            <th class="text-end">Kalan</th>
          </tr>
        </thead>
        <tbody>
          <% if (policies.length === 0) { %>
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">Bu müşteriye ait poliçe bulunamadı.</td>
            </tr>
          <% } else { %>
            <% policies.forEach(function(p) { %>
              <tr>
                <td><%= p.policy_number %></td>
                <td><%= p.insurer %></td>
                <td><%= p.policy_type || '-' %></td>
                <td><%= p.start_date %></td>
                <td><%= p.end_date %></td>
                <td class="text-end"><%= p.premium_total.toFixed ? p.premium_total.toFixed(2) : (p.premium_total || 0) %></td>
                <td class="text-end"><%= p.premium_paid.toFixed ? p.premium_paid.toFixed(2) : (p.premium_paid || 0) %></td>
                <td class="text-end"><%= p.premium_remaining.toFixed ? p.premium_remaining.toFixed(2) : (p.premium_remaining || 0) %></td>
              </tr>
            <% }) %>
          <% } %>
          <% if (stats.manualDebt > 0) { %>
            <tr>
              <td colspan="5"><strong>Manuel Eklenen Borç / Devir Bakiyesi</strong></td>
              <td class="text-end"><strong><%= stats.manualDebt.toFixed(2) %></strong></td>
              <td class="text-end">-</td>
              <td class="text-end"><strong><%= stats.manualDebt.toFixed(2) %></strong></td>
            </tr>
          <% } %>
          <tr class="table-dark">
            <td colspan="5" class="text-end"><strong>GENEL TOPLAM (Borç/Tahsilat)</strong></td>
            <td class="text-end"><strong><%= stats.totalReceivable.toFixed(2) %></strong></td>
            <td class="text-end"><strong><%= stats.totalPaidAll.toFixed(2) %></strong></td>
            <td class="text-end"><strong><%= stats.totalRemaining.toFixed(2) %></strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Fatura Toplamı</label>
        <input type="number" step="0.01" class="form-control" id="invoiceTotal" name="total" value="<%= stats.totalRemaining %>">
      </div>
      <div class="col-md-4">
        <label class="form-label">Tahsil Edilen Tutar</label>
        <input type="number" step="0.01" class="form-control" id="invoicePaid" name="paid" value="0">
      </div>
      <div class="col-md-4">
        <label class="form-label">Kalan Borç</label>
        <input type="number" step="0.01" class="form-control" id="invoiceRemaining" name="remaining" readonly>
      </div>
      <div class="col-md-12">
        <label class="form-label">Açıklama / Not</label>
        <textarea class="form-control" id="invoiceNote" name="note" rows="3" placeholder="Örneğin: 1. taksit tahsil edildi, kalan 2 taksit ..."></textarea>
      </div>
    </div>

    <div class="row mt-4 d-print-none">
      <div class="col-md-6">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Tahsilatı Kaydet</button>
      </div>
      <div class="col-md-6 text-end">
        <button type="button" class="btn btn-success" onclick="window.print()"><i class="bi bi-printer"></i> Yazdır</button>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 text-center">
        <p class="mb-5">Müşteri İmzası</p>
        <p>...........................................</p>
      </div>
      <div class="col-md-6 text-center">
        <p class="mb-5">Yetkili İmza</p>
        <p>...........................................</p>
      </div>
    </div>
  </div>
</form>

<script>
  (function () {
    var d = new Date();
    var dd = String(d.getDate()).padStart(2, '0');
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var yyyy = d.getFullYear();
    var el = document.getElementById('invoiceDate');
    if (el) el.textContent = dd + '.' + mm + '.' + yyyy;
    var dateInput = document.getElementById('invoiceDateInput');
    if (dateInput) dateInput.value = yyyy + '-' + mm + '-' + dd;

    var totalInput = document.getElementById('invoiceTotal');
    var paidInput = document.getElementById('invoicePaid');
    var remainingInput = document.getElementById('invoiceRemaining');

    function recalc() {
      var total = parseFloat(totalInput.value.replace(',', '.')) || 0;
      var paid = parseFloat(paidInput.value.replace(',', '.')) || 0;
      var remaining = total - paid;
      remainingInput.value = remaining.toFixed(2);
    }

    if (totalInput && paidInput && remainingInput) {
      totalInput.addEventListener('input', recalc);
      paidInput.addEventListener('input', recalc);
      recalc();
    }
  })();
</script>
