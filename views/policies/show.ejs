<div class="row mb-4">
  <div class="col-md-8">
    <h1 class="h3"><i class="bi bi-file-earmark-text"></i> Poliçe Detayı: <%= policy.policy_number %></h1>
  </div>
  <div class="col-md-4 text-end">
    <a href="/policies/<%= policy.id %>/edit" class="btn btn-warning"><i class="bi bi-pencil"></i> Düzenle</a>
    <a href="/policies?<%= typeof qs !== 'undefined' ? qs : '' %>" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Listeye Dön</a>
  </div>
</div>

<div class="row">
  <!-- Müşteri Bilgileri -->
  <div class="col-md-4 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0"><i class="bi bi-person"></i> Müşteri Bilgileri</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
            <label class="text-muted small">Ad Soyad</label>
            <div class="fw-bold fs-5">
              <a href="/customers/<%= policy.customer_id %>" class="text-decoration-none">
                <%= policy.customer_name || '-' %>
              </a>
            </div>
        </div>
        <div class="mb-3">
            <label class="text-muted small">Telefon</label>
            <div><%= policy.customer_phone || '-' %></div>
        </div>
        <div class="mb-3">
            <label class="text-muted small">TCKN / Vergi No</label>
            <div><%= policy.customer_id_no || '-' %></div>
        </div>
        <div class="mb-3">
            <label class="text-muted small">E-posta</label>
            <div><%= policy.customer_email || '-' %></div>
        </div>
        <div class="mb-3">
            <label class="text-muted small">Doğum Tarihi</label>
            <div><%= policy.customer_birth_date || '-' %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Poliçe Detayları -->
  <div class="col-md-8 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0"><i class="bi bi-shield-check"></i> Poliçe Detayları</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="text-muted small">Sigorta Şirketi</label>
                <div class="fw-bold"><%= policy.insurer %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Poliçe Türü</label>
                <div><span class="badge bg-info text-dark"><%= policy.policy_type || 'Diğer' %></span></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Poliçe No</label>
                <div class="fw-bold font-monospace"><%= policy.policy_number %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Tanzim Tarihi</label>
                <div><%= policy.issue_date || '-' %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Başlangıç Tarihi</label>
                <div class="fw-bold text-success"><%= policy.start_date %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Bitiş Tarihi</label>
                <div class="fw-bold text-danger"><%= policy.end_date %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Durum</label>
                <div>
                    <% if (policy.status === 'active' || policy.status === 'Aktif') { %>
                        <span class="badge bg-success">Aktif</span>
                    <% } else if (policy.status === 'cancelled' || policy.status === 'İptal') { %>
                        <span class="badge bg-danger">İptal</span>
                    <% } else { %>
                        <span class="badge bg-secondary"><%= policy.status %></span>
                    <% } %>
                </div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Toplam Prim</label>
                <div><%= typeof policy.premium_total !== 'undefined' && policy.premium_total !== null ? policy.premium_total.toFixed ? policy.premium_total.toFixed(2) : policy.premium_total : '-' %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Ödenen Tutar</label>
                <div><%= typeof policy.premium_paid !== 'undefined' && policy.premium_paid !== null ? policy.premium_paid.toFixed ? policy.premium_paid.toFixed(2) : policy.premium_paid : '-' %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Kalan Tutar</label>
                <div><%= typeof policy.premium_remaining !== 'undefined' && policy.premium_remaining !== null ? policy.premium_remaining.toFixed ? policy.premium_remaining.toFixed(2) : policy.premium_remaining : '-' %></div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small">Ödeme Dekontu / Açıklama</label>
                <div><%= policy.payment_note || '-' %></div>
            </div>
          <div class="col-md-6">
                <label class="text-muted small">Kalan Gün</label>
                <div>
                    <% if (policy.days_remaining < 0) { %>
                        <span class="badge bg-danger">Süresi Doldu</span>
                    <% } else { %>
                        <span class="fw-bold"><%= policy.days_remaining %> gün</span>
                    <% } %>
                </div>
            </div>
            <% if (policy.policy_type === 'Trafik' || policy.policy_type === 'Kasko') { %>
              <div class="col-md-6">
                <label class="text-muted small">Plaka</label>
                <div class="fw-bold"><%= policy.policy_details && policy.policy_details.plate ? policy.policy_details.plate : '-' %></div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small">Ruhsat Tescil No</label>
                <div><%= policy.policy_details && policy.policy_details.registration_no ? policy.policy_details.registration_no : '-' %></div>
              </div>
              <% if (policy.policy_type === 'Kasko') { %>
                <div class="col-md-6">
                  <label class="text-muted small">Meslek</label>
                  <div><%= policy.policy_details && policy.policy_details.profession ? policy.policy_details.profession : '-' %></div>
                </div>
              <% } %>
            <% } %>
            <% if (policy.policy_type === 'DASK' || policy.policy_type === 'Konut') { %>
              <div class="col-md-6">
                <label class="text-muted small">Metrekare (m²)</label>
                <div class="fw-bold"><%= policy.policy_details && policy.policy_details.area_sqm ? policy.policy_details.area_sqm : '-' %></div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small">Bina Yaşı</label>
                <div><%= policy.policy_details && policy.policy_details.building_age ? policy.policy_details.building_age : '-' %></div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small">Binadaki Kat Sayısı</label>
                <div><%= policy.policy_details && policy.policy_details.total_floors ? policy.policy_details.total_floors : '-' %></div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small">Bulunduğu Kat</label>
                <div><%= policy.policy_details && policy.policy_details.floor_no ? policy.policy_details.floor_no : '-' %></div>
              </div>
              <div class="col-md-12">
                <label class="text-muted small">Adres Kodu</label>
                <div><%= policy.policy_details && policy.policy_details.address_code ? policy.policy_details.address_code : '-' %></div>
              </div>
            <% } %>
            <% if (policy.policy_type === 'Sağlık') { %>
              <% const healthPersons = (policy.policy_details && policy.policy_details.health_persons) || []; %>
              <div class="col-12">
                <label class="text-muted small">Sağlık Poliçesindeki Kişiler</label>
                <% if (healthPersons.length === 0) { %>
                  <div class="p-2 bg-light rounded border">Kişi eklenmemiş.</div>
                <% } else { %>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <thead>
                        <tr>
                          <th>Ad Soyad</th>
                          <th>TCKN</th>
                          <th>Doğum Tarihi</th>
                          <th>Yakınlık</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% healthPersons.forEach(function(hp) { %>
                          <tr>
                            <td><%= hp.name || '-' %></td>
                            <td><%= hp.id_no || '-' %></td>
                            <td><%= hp.birth_date || '-' %></td>
                            <td><%= hp.relation || '-' %></td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                <% } %>
              </div>
            <% } %>
            <div class="col-12">
                <label class="text-muted small">Açıklama / Notlar</label>
                <div class="p-3 bg-light rounded border"><%= policy.description || 'Not yok.' %></div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
