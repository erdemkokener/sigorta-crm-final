<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Poliçeler</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <a href="/policies?filter=today" class="btn btn-sm btn-outline-danger">Bugün Bitenler</a>
      <a href="/policies?filter=tomorrow" class="btn btn-sm btn-outline-warning">Yarın Bitenler</a>
      <a href="/policies/export.xlsx?<%= qs %>" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-excel"></i> Excel'e Aktar</a>
      <a href="/policies/import" class="btn btn-sm btn-outline-secondary"><i class="bi bi-upload"></i> Excel Yükle</a>
    </div>
    <a href="/policies/new" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg"></i> Yeni Poliçe</a>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-left-primary shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Toplam Müşteri</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800"><%= typeof totalCustomers !== 'undefined' ? totalCustomers : '-' %></div>
          </div>
          <div class="col-auto">
            <i class="bi bi-people fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card border-left-success shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Toplam Poliçe</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800"><%= typeof totalPolicies !== 'undefined' ? totalPolicies : '-' %></div>
          </div>
          <div class="col-auto">
            <i class="bi bi-file-text fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <h6 class="mb-0">Filtrele</h6>
  </div>
  <div class="card-body">
    <form class="row g-3" method="get" action="/policies">
      <div class="col-md-3">
        <label class="form-label">Arama</label>
        <input type="text" class="form-control" name="q" placeholder="Müşteri, Poliçe No..." value="<%= (typeof qs !== 'undefined' && new URLSearchParams(qs).get('q')) || '' %>">
      </div>
      <div class="col-md-3">
        <label class="form-label">Sigortacı</label>
        <input type="text" class="form-control" name="insurer" value="<%= (typeof qs !== 'undefined' && new URLSearchParams(qs).get('insurer')) || '' %>">
      </div>
      <div class="col-md-2">
        <label class="form-label">Durum</label>
        <select class="form-select" name="status">
          <% const s = (typeof qs !== 'undefined' && new URLSearchParams(qs).get('status')) || '' %>
          <option value="" <%= s===''?'selected':'' %>>Tümü</option>
          <option value="active" <%= s==='active'?'selected':'' %>>Aktif</option>
          <option value="cancelled" <%= s==='cancelled'?'selected':'' %>>İptal</option>
          <option value="pending" <%= s==='pending'?'selected':'' %>>Beklemede</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Bitiş (Başlangıç)</label>
        <input type="date" class="form-control" name="end_from" value="<%= (typeof qs !== 'undefined' && new URLSearchParams(qs).get('end_from')) || '' %>">
      </div>
      <div class="col-md-2">
        <label class="form-label">Bitiş (Bitiş)</label>
        <input type="date" class="form-control" name="end_to" value="<%= (typeof qs !== 'undefined' && new URLSearchParams(qs).get('end_to')) || '' %>">
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-funnel"></i> Filtrele</button>
        <a href="/policies" class="btn btn-outline-secondary">Temizle</a>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-end mb-3">
    <form action="/api/trigger-notifications" method="post">
      <button class="btn btn-warning btn-sm"><i class="bi bi-bell"></i> Bildirimleri Kontrol Et</button>
    </form>
</div>

<div class="table-responsive">
  <table class="table table-hover align-middle shadow-sm rounded overflow-hidden">
    <thead class="table-dark">
      <tr>
        <th>Müşteri</th>
        <th>Telefon</th>
        <th>Kimlik No</th>
        <th>Sigortacı</th>
        <th>Tür</th>
        <th>Poliçe No</th>
        <th>Başlangıç</th>
        <th>Bitiş</th>
        <th>Kalan</th>
        <th>Durum</th>
        <th class="text-end">İşlem</th>
      </tr>
    </thead>
    <tbody>
      <% if (policies.length === 0) { %>
        <tr>
          <td colspan="11" class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-4 d-block mb-3"></i>
            Kayıt bulunamadı.
          </td>
        </tr>
      <% } %>
      <% policies.forEach(p => { %>
        <tr class="<%= p.is_expired ? 'table-danger' : (p.is_expiring_soon ? 'table-warning' : '') %>">
          <td>
             <a href="/customers/<%= p.customer_id %>" class="text-decoration-none fw-bold text-dark">
               <%= p.customer_name || '-' %>
             </a>
          </td>
          <td><%= p.customer_phone || '-' %></td>
          <td><%= p.customer_id_no || '-' %></td>
          <td><%= p.insurer %></td>
          <td><span class="badge bg-info text-dark"><%= p.policy_type || 'Diğer' %></span></td>
          <td><%= p.policy_number %></td>
          <td><%= p.start_date %></td>
          <td><%= p.end_date %></td>
          <td>
            <% if (p.days_remaining < 0) { %>
                <span class="badge bg-danger">Süresi Doldu</span>
            <% } else { %>
                <span class="fw-bold"><%= p.days_remaining %> gün</span>
            <% } %>
          </td>
          <td>
             <% if (p.status === 'active' || p.status === 'Aktif') { %>
               <span class="badge bg-success">Aktif</span>
             <% } else if (p.status === 'cancelled' || p.status === 'İptal') { %>
               <span class="badge bg-danger">İptal</span>
             <% } else { %>
               <span class="badge bg-secondary"><%= p.status %></span>
             <% } %>
          </td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <a href="/policies/<%= p.id %>" class="btn btn-outline-primary" title="Detay"><i class="bi bi-eye"></i></a>
              <a href="/policies/<%= p.id %>/edit" class="btn btn-outline-warning" title="Düzenle"><i class="bi bi-pencil"></i></a>
              <form action="/policies/<%= p.id %>/delete" method="post" class="d-inline" onsubmit="return confirm('Silmek istediğinize emin misiniz?')">
                <button class="btn btn-outline-danger" title="Sil"><i class="bi bi-trash"></i></button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
