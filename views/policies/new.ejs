<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="mb-0">Yeni Poliçe Ekle</h5>
      </div>
      <div class="card-body">
        <form action="/policies" method="post" class="row g-3">
          <div class="col-md-12">
            <label class="form-label">Müşteri <span class="text-danger">*</span></label>
            <select class="form-select" name="customer_id" required>
              <option value="">Seçiniz</option>
              <% customers.forEach(c => { %>
                <option value="<%= c.id %>" data-id-no="<%= c.id_no || '' %>"><%= c.name %> (<%= c.phone || '-' %>)</option>
              <% }) %>
            </select>
            <div class="form-text">Listede yoksa önce <a href="/customers/new">yeni müşteri ekleyin</a>.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">TC/VKN ile Müşteri Bul</label>
            <div class="input-group">
              <input type="text" class="form-control" id="customerSearchIdNo" placeholder="TC veya Vergi No yazın">
              <button type="button" class="btn btn-outline-secondary" id="customerSearchBtn">Bul</button>
            </div>
            <div class="form-text" id="customerSearchResult"></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Sigorta Şirketi <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="insurer" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Poliçe Türü</label>
            <select class="form-select" name="policy_type">
              <option value="Trafik">Trafik</option>
              <option value="Kasko">Kasko</option>
              <option value="Konut">Konut</option>
              <option value="DASK">DASK</option>
              <option value="Sağlık">Sağlık</option>
              <option value="Kısa Süreli Trafik">Kısa Süreli Trafik</option>
              <option value="Diğer" selected>Diğer</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Poliçe No <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="policy_number" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tanzim Tarihi</label>
            <input type="date" class="form-control" name="issue_date">
          </div>
          <div class="col-md-6">
            <label class="form-label">Başlangıç Tarihi <span class="text-danger">*</span></label>
            <input type="date" class="form-control" name="start_date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Bitiş Tarihi <span class="text-danger">*</span></label>
            <input type="date" class="form-control" name="end_date" required>
          </div>
          <div class="col-md-12">
            <label class="form-label">Poliçe Bilgileri / Açıklama</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Durum</label>
            <select class="form-select" name="status">
              <option value="active">Aktif</option>
              <option value="cancelled">İptal</option>
              <option value="pending">Beklemede</option>
            </select>
          </div>

      <div class="col-12 mt-4 text-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Kaydet</button>
        <a href="/policies" class="btn btn-secondary"><i class="bi bi-x"></i> İptal</a>
      </div>
    </form>
  </div>
</div>
</div>

<script>
  const customerSelect = document.querySelector('select[name="customer_id"]');
  const searchInput = document.getElementById('customerSearchIdNo');
  const searchBtn = document.getElementById('customerSearchBtn');
  const searchResult = document.getElementById('customerSearchResult');

  function findCustomerByIdNo() {
    if (!customerSelect || !searchInput || !searchResult) return;
    const raw = (searchInput.value || '').trim();
    if (!raw) {
      searchResult.textContent = '';
      searchResult.classList.remove('text-success', 'text-danger');
      return;
    }
    const normalized = raw.replace(/\D/g, '');
    let foundOption = null;
    customerSelect.querySelectorAll('option').forEach(opt => {
      const idNo = (opt.getAttribute('data-id-no') || '').replace(/\D/g, '');
      if (idNo && idNo === normalized) {
        foundOption = opt;
      }
    });
    if (foundOption) {
      customerSelect.value = foundOption.value;
      searchResult.textContent = 'Müşteri bulundu ve seçildi: ' + foundOption.textContent;
      searchResult.classList.remove('text-danger');
      searchResult.classList.add('text-success');
    } else {
      customerSelect.value = '';
      searchResult.textContent = 'Bu TC/VKN ile kayıtlı müşteri bulunamadı.';
      searchResult.classList.remove('text-success');
      searchResult.classList.add('text-danger');
    }
  }

  if (searchBtn && searchInput) {
    searchBtn.addEventListener('click', findCustomerByIdNo);
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        findCustomerByIdNo();
      }
    });
  }
</script>
  </div>
</div>
<script>
  const startDateInput = document.querySelector('input[name="start_date"]');
  const endDateInput = document.querySelector('input[name="end_date"]');
  const policyTypeSelect = document.querySelector('select[name="policy_type"]');

  function updateEndDate() {
    const startDateVal = startDateInput.value;
    if (!startDateVal) return;

    const startDate = new Date(startDateVal);
    const policyType = policyTypeSelect.value;
    let endDate = new Date(startDate);

    if (policyType === 'Kısa Süreli Trafik') {
      endDate.setDate(startDate.getDate() + 60);
    } else {
      endDate.setFullYear(startDate.getFullYear() + 1);
    }

    const yyyy = endDate.getFullYear();
    const mm = String(endDate.getMonth() + 1).padStart(2, '0');
    const dd = String(endDate.getDate()).padStart(2, '0');
    endDateInput.value = `${yyyy}-${mm}-${dd}`;
  }

  startDateInput.addEventListener('change', updateEndDate);
  policyTypeSelect.addEventListener('change', updateEndDate);
</script>
